{% extends "base.html" %}
{% block content %}
<h2 class="text-2xl font-bold text-brand mb-4">{{ course and ('Manage: ' ~ course.title) or 'Create Course' }}</h2>

{% if not course %}
  <!-- CREATE COURSE FORM -->
  <form method="post" action="/admin/courses/new" enctype="multipart/form-data" class="space-y-3 max-w-xl">
    <input name="title" class="border rounded w-full px-3 py-2" placeholder="Course title" required>
    <input name="course_code" class="border rounded w-full px-3 py-2" placeholder="Course code (e.g., CSE250)" required>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
      <label>Start date
        <input type="date" name="start_date" class="border rounded w-full px-3 py-2">
      </label>
      <label>End date
        <input type="date" name="end_date" class="border rounded w-full px-3 py-2">
      </label>
    </div>

    <label>Cover image (jpg/png/webp, max 5 MB)
      <input type="file" name="picture" accept="image/png, image/jpeg, image/webp" class="border rounded w-full px-3 py-2">
    </label>

    <textarea name="description" class="border rounded w-full px-3 py-2" placeholder="Description"></textarea>
    <input name="tags" class="border rounded w-full px-3 py-2" placeholder="Tags (comma)">
    <label class="flex items-center gap-2"><input type="checkbox" name="published"> Published</label>

    <button class="bg-brand text-white px-4 py-2 rounded hover:bg-brand-dark">Create</button>
  </form>

{% else %}
  <!-- MANAGE COURSE VIEW -->
  <p class="text-slate-700 mb-2">{{ course.description }}</p>

  <!-- ADD THE COVER UPLOAD BLOCK HERE -->
  <div class="border rounded p-4 mt-4">
    <h4 class="font-semibold mb-2">Course Cover</h4>
    <img src="{{ course.cover_url }}" class="w-full max-w-md rounded mb-2"
         onerror="this.onerror=null;this.src='/static/images/course-default.jpg';">
    <form method="post" action="/admin/courses/{{ course.id }}/picture" enctype="multipart/form-data" class="flex items-center gap-2">
      <input type="file" name="picture" accept="image/png, image/jpeg, image/webp" class="border rounded px-3 py-2">
      <button class="bg-brand text-white px-4 py-2 rounded hover:bg-brand-dark">Upload</button>
    </form>
  </div>
  <!-- END COVER UPLOAD BLOCK -->

  <h3 class="font-semibold mt-4">Add Week</h3>
  <form method="post" action="/admin/courses/{{ course.id }}/weeks/new" class="space-x-2">
    <input type="number" min="1" name="number" class="border rounded px-3 py-2" placeholder="Week #" required>
    <input name="title" class="border rounded px-3 py-2" placeholder="Title">
    <button class="bg-brand text-white px-4 py-2 rounded hover:bg-brand-dark">Add Week</button>
  </form>

  {% for w in weeks %}
    <div class="border rounded p-4 mt-4">
      <h4 class="font-semibold">Week {{ w.number }} — {{ w.title }}</h4>
      <ul class="list-disc pl-5">
        {% for l in w.lessons %}
          <li>#{{ l.position }} — {{ l.title }} ({{ l.type }})
            {% if l.type == 'quiz' %}
              <a class="text-brand underline" href="/quizzes/builder/{{ l.id }}">Edit Quiz</a>
            {% endif %}
            {% if l.due_at %}<span class="text-sm text-slate-500"> (due {{ l.due_at }})</span>{% endif %}
          </li>
        {% endfor %}
      </ul>

      <details class="mt-2">
        <summary class="cursor-pointer text-brand">Add Lesson</summary>
        <form method="post" action="/admin/weeks/{{ w.id }}/lessons/new" class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
          <label>Position <input type="number" name="position" min="1" required class="border rounded px-3 py-2 w-full"></label>
          <label>Type
            <select name="type" class="border rounded px-3 py-2 w-full">
              <option value="content">Content</option>
              <option value="assignment">Assignment</option>
              <option value="quiz">Quiz</option>
            </select>
          </label>
          <label>Title <input name="title" required class="border rounded px-3 py-2 w-full"></label>
          <label>Description <textarea name="description" class="border rounded px-3 py-2 w-full"></textarea></label>
          <label>Content URL (YouTube/PDF/link) <input name="content_url" class="border rounded px-3 py-2 w-full"></label>
          <label>Assignment Google Form URL <input name="assignment_form_url" class="border rounded px-3 py-2 w-full"></label>
          <label>Due At (ISO for assignment/quiz) <input name="due_at" placeholder="YYYY-MM-DDTHH:MM:SS+00:00" class="border rounded px-3 py-2 w-full"></label>
          <label>Quiz Title <input name="quiz_title" class="border rounded px-3 py-2 w-full"></label>
          <div class="md:col-span-2">
            <button class="bg-brand text-white px-4 py-2 rounded hover:bg-brand-dark">Add Lesson</button>
          </div>
        </form>
      </details>
    </div>
  {% endfor %}
{% endif %}
{% endblock %}